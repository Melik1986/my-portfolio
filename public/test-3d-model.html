<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Model Test</title>
    <style>
        body { 
            margin: 0; 
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        #canvas-container {
            width: 600px;
            height: 600px;
            border: 2px solid #333;
            position: relative;
            margin: 20px auto;
        }
        #status {
            text-align: center;
            margin: 20px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 5px;
        }
        .error { color: red; }
        .success { color: green; }
        #debug {
            margin: 20px auto;
            max-width: 800px;
            padding: 20px;
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1 style="text-align: center;">3D Avatar Model Test</h1>
    <div id="status">Загрузка...</div>
    <div id="canvas-container"></div>
    <div id="debug">
        <h3>Debug Info:</h3>
        <div id="debug-content"></div>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.169.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.169.0/examples/jsm/"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        const debugLog = (message, type = 'info') => {
            const debugContent = document.getElementById('debug-content');
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            debugContent.innerHTML += `<div style="color: ${color}">[${time}] ${message}</div>`;
            console.log(`[${type}] ${message}`);
        };

        const updateStatus = (message, isError = false) => {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = isError ? 'error' : 'success';
        };

        async function init() {
            debugLog('Начало инициализации...');
            
            const container = document.getElementById('canvas-container');
            
            // Scene
            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf0f0f0);
            debugLog('Сцена создана');

            // Camera
            const camera = new THREE.PerspectiveCamera(
                45,
                container.clientWidth / container.clientHeight,
                0.1,
                1000
            );
            camera.position.set(0, 0.5, 2);
            debugLog('Камера настроена');

            // Renderer
            const renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            container.appendChild(renderer.domElement);
            debugLog('Рендерер создан и добавлен в DOM');

            // Controls
            const controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            debugLog('Контроллы камеры настроены');

            // Lights
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(5, 5, 5);
            directionalLight.castShadow = true;
            scene.add(directionalLight);
            debugLog('Освещение добавлено');

            // Ground
            const groundGeometry = new THREE.CylinderGeometry(0.6, 0.6, 0.1, 64);
            const groundMaterial = new THREE.MeshStandardMaterial({ color: 0x808080 });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.receiveShadow = true;
            ground.position.y = -0.05;
            scene.add(ground);
            debugLog('Платформа создана');

            // Load model
            const loader = new GLTFLoader();
            const modelPath = '/model/avatar.glb';
            debugLog(`Начинаем загрузку модели: ${modelPath}`);
            updateStatus('Загрузка модели...');

            loader.load(
                modelPath,
                (gltf) => {
                    debugLog('Модель загружена успешно!', 'success');
                    debugLog(`Анимаций в модели: ${gltf.animations.length}`);
                    
                    const model = gltf.scene;
                    
                    // Center and scale model
                    const box = new THREE.Box3().setFromObject(model);
                    const center = box.getCenter(new THREE.Vector3());
                    const size = box.getSize(new THREE.Vector3());
                    
                    debugLog(`Размер модели: ${size.x.toFixed(2)} x ${size.y.toFixed(2)} x ${size.z.toFixed(2)}`);
                    
                    model.position.sub(center);
                    model.position.y = 0;
                    
                    // Enable shadows
                    model.traverse((child) => {
                        if (child.isMesh) {
                            child.castShadow = true;
                            child.receiveShadow = true;
                        }
                    });
                    
                    scene.add(model);
                    debugLog('Модель добавлена в сцену', 'success');
                    updateStatus('Модель загружена успешно!', false);
                    
                    // Setup animations if available
                    if (gltf.animations.length > 0) {
                        const mixer = new THREE.AnimationMixer(model);
                        const action = mixer.clipAction(gltf.animations[0]);
                        action.play();
                        
                        // Animation loop
                        const clock = new THREE.Clock();
                        function animateModel() {
                            requestAnimationFrame(animateModel);
                            const delta = clock.getDelta();
                            mixer.update(delta);
                        }
                        animateModel();
                        debugLog('Анимация запущена');
                    }
                },
                (progress) => {
                    const percent = (progress.loaded / progress.total * 100).toFixed(2);
                    debugLog(`Загрузка: ${percent}%`);
                    updateStatus(`Загрузка модели: ${percent}%`);
                },
                (error) => {
                    debugLog(`Ошибка загрузки модели: ${error.message}`, 'error');
                    updateStatus(`Ошибка: ${error.message}`, true);
                    console.error('Полная ошибка:', error);
                }
            );

            // Animation loop
            function animate() {
                requestAnimationFrame(animate);
                controls.update();
                renderer.render(scene, camera);
            }
            animate();
            debugLog('Цикл рендеринга запущен');

            // Handle resize
            window.addEventListener('resize', () => {
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);
                debugLog('Размер обновлен');
            });
        }

        // Check WebGL support
        if (WebGL2RenderingContext) {
            debugLog('WebGL2 поддерживается', 'success');
            init();
        } else {
            debugLog('WebGL2 не поддерживается!', 'error');
            updateStatus('WebGL2 не поддерживается в вашем браузере!', true);
        }
    </script>
</body>
</html>